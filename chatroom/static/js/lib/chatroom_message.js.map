{"version":3,"sources":["../src/chatroom_message.js"],"names":["$","document","ready","time_now","format_time_now","text","split","attr","get_messages","date","Date","add_zero","String","s","length","replace","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds","getMilliseconds","ajax","url","method","dataType","data","last_message_time","slice","id","timeout","done","messages","console","log","forEach","message","time_str","sender","sender_ip","time","content_str","is_file","append","fs","Number","css","ele","children","limit_height","scrollTop","scrollHeight","fail","xhr","status","error","keydown","event","ctrlKey","keyCode","preventDefault","detect_name","val","get_my_ip","message_editor","message_text","alert","substr","submit","form","serialize","response"],"mappings":"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","file":"chatroom_message.js","sourcesContent":["'use strict';\n\n// initial time\n$(document).ready(function() {\n    let time_now = format_time_now()\n    $('.message-time').text(time_now.split('.')[0])\n    $('.message-wrapper').attr('id', time_now)\n\n    get_messages()\n})\n\nfunction format_time_now() {\n    let date = new Date()\n    let time_now = '%Y-%m-%d %H:%M:%S'\n    let add_zero = s => String(s).length === 2 ? s : '0' + String(s)\n    time_now = time_now.replace('%Y', date.getFullYear())\n    time_now = time_now.replace('%m', add_zero(date.getMonth() + 1))\n    time_now = time_now.replace('%d', add_zero(date.getDate()))\n    time_now = time_now.replace('%H', add_zero(date.getHours()))\n    time_now = time_now.replace('%M', add_zero(date.getMinutes()))\n    time_now = time_now.replace('%S', add_zero(date.getSeconds()))\n    time_now += '.' + String(date.getMilliseconds())\n    return time_now\n}\n\n// ========== get messages ==========\nfunction get_messages() {\n    $.ajax({\n        url: '/get_messages',\n        method: 'GET',\n        dataType: 'json',\n        data: {last_message_time: $('.message-wrapper').slice(-1)[0].id},\n        timeout: 60000, // long polling\n    })\n    .done(function(messages) {\n        console.log('get_messages SUCCESS');\n        messages.forEach(function(message) {\n            let time_str = '<div id=\"${message.time}\" class=\"message-wrapper\">'\n            // determine whether the new message is sent by user self\n            if ($('#name-editor').text() === message.sender && $('#my-ip').text() === message.sender_ip) {\n                time_str += `<div id=\"${message.time}\" class=\"message-wrapper\"><div class=\"message-time\">${message.time.split('.')[0].split(' ')[1]}`\n                time_str += '&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'\n                time_str += `<span class=\"message-arrow\">➢➣➤</span></div>`\n            } else {\n                time_str += `<div id=\"${message.time}\" class=\"message-wrapper\"><div class=\"message-time\">${message.time.split('.')[0]}</div>`\n            }\n\n            let content_str = `<div class=\"message-content\"><span class=\"user-name\">${message.sender}</span>`\n            content_str += `@<span class=\"user-ip\">${message.sender_ip}</span>`\n            // determine whether the new message is file uploading\n            if (message.is_file) {\n                content_str += ` : <span class=\"message-text\"><span class=\"mark\">UPLOAD</span> <a class=\"uploaded-file\" href=\"static/upload/${message.text}\">${message.text}</a></span></div></div>`\n            } else {\n                content_str += ` : <span class=\"message-text\">${message.text}</span></div></div>`\n            }\n\n            $('#message-list').append(time_str + content_str)\n\n            // limit the height of the new message\n            let fs = Number($('html').css('font-size').slice(0,-2))\n            let ele = $($('#message-list').children().slice(-1)[0])\n            limit_height(ele,fs)\n        })\n        // scroll to bottom\n        $('#message-list').scrollTop($('#message-list')[0].scrollHeight)\n\n        get_messages() // Automatically re-query\n    })\n    .fail(function(xhr, status, error) {\n        if (status === 'timeout') {\n            console.log('get_messages timeout');\n\n            get_messages() // Automatically re-query\n        } else {\n            console.log(\"get_messages FAIL:\", xhr.status, status, '\\n', error);\n        }\n    })\n}\n\n// ========== send my message ==========\n$('#message-editor').keydown(function(event) {\n    if (event.ctrlKey && event.keyCode === 13) {\n        event.preventDefault() /*prevent wrapping automatically*/\n        if (detect_name('#name-editor')) {\n            $('input[name=name]').val($('#name-editor').text())\n        } else {\n            return\n        }\n        get_my_ip()\n\n        let message_editor = $(this)\n        let message_text = message_editor.val()\n        if (message_text.length > 1000) {\n            alert('Your message can not be longer than 1000 characters!')\n            message_editor.val(message_text.substr(0,1000))\n            return\n        }\n        $('#send-my-message').submit()\n    }\n})\n$('#send-my-message').submit(function(event) {\n    event.preventDefault() /* prevent page jump*/\n    let form = $(this)\n    $.ajax({\n        url: '/send_my_message',\n        method: 'POST',\n        data: form.serialize()\n    })\n    .done(function(response) {\n        console.log(\"send my message SUCCESS\");\n        $('#message-editor').val(\"\")\n    })\n    .fail(function(xhr, status, error) {\n        console.log(\"send my message FAIL:\", xhr.status, status, '\\n', error);\n    })\n})\n"]}